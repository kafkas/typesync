rules_version = '2';
service cloud.firestore {
  // typesync-start
  // Type Validators

  function isValidUserRole(data) {
    return ((data == 'owner') || (data == 'admin') || (data == 'member'));
  }

  function isValidUser(data) {
    return (
    (data is map) &&
    (data.keys().hasOnly(['name', 'role', 'website_url', 'created_at'])) &&
    (data.name is string) &&
    isValidUserRole(data.role) &&
    ((data.website_url is string) || !('website_url' in data)) &&
    (data.created_at is timestamp)
    );
  }

  function isValidWorkspace(data) {
    return (
    (data is map) &&
    (data.keys().hasOnly(['info', 'metadata', 'created_at'])) &&
    (
    (data.info is map) &&
    (data.info.keys().hasOnly(['name', 'description'])) &&
    (data.info.name is string) &&
    (data.info.description is string)
    ) &&
    (data.metadata is map) &&
    (data.created_at is timestamp)
    );
  }

  // Read-only field validators

  function isReadonlyFieldAffectedForUser() {
    let readonlyFields = ['role', 'created_at'];
    let changedFields = request.resource.data.diff(resource.data).affectedKeys();
    return changedFields.hasAny(readonlyFields);
  }

  function isReadonlyFieldAffectedForWorkspace() {
    let readonlyFields = ['created_at'];
    let readonlyFieldsForInfo = ['name'];
    let changedFields = request.resource.data.diff(resource.data).affectedKeys();
    let changeFieldsForInfo = request.resource.data.info.diff(resource.data.info).affectedKeys();
    return changedFields.hasAny(readonlyFields) || changeFieldsForInfo.hasAny(readonlyFieldsForInfo);
  }
  // typesync-end

  match /databases/{database}/documents {
    match /users/{userId} {
      function isLegalUserUpdate() {
        return !isReadonlyFieldAffectedForUser() && isValidUser(request.resource.data);
      }

      allow read;
      allow create: if isValidUser(request.resource.data);
      allow update: if isLegalUserUpdate();
      allow delete: if false;
    }

    match /projects/{projectId} {
      allow read, create, update, delete;
    }
  }
}